<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Frase causale 3</title>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: white;
      font-family: sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .wrapper {
      width: 100%;
      max-width: 900px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* Due schermate */
    .screen {
      width: 100%;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 15px;
      padding: 10px 0;
    }
    #screen1 { display: flex; }

    .media-slot {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* VIDEO */
    .video-media {
      max-width: 80vw;
      max-height: 80vh;
      width: auto;
      height: auto;
      object-fit: contain;
      display: block;
    }

    /* IMMAGINE + spot */
    .media-wrap {
      position: relative;
      display: inline-block;
      line-height: 0;
    }

    .img-media {
      max-width: 80vw;
      max-height: 80vh;
      width: auto;
      height: auto;
      object-fit: contain;
      display: block;
      cursor: pointer;
      user-select: none;
      -webkit-user-drag: none;
      touch-action: manipulation;
    }

    .fade-spot {
      position: absolute;
      left: 0;
      top: 0;
      width: 0;
      height: 0;
      transform: translate(-50%, -50%);
      pointer-events: none;
      background: rgba(255,255,255,0.55);
      -webkit-mask-image: radial-gradient(ellipse at center,
        rgba(0,0,0,1) 0 82%,
        rgba(0,0,0,0) 98%);
              mask-image: radial-gradient(ellipse at center,
        rgba(0,0,0,1) 0 82%,
        rgba(0,0,0,0) 98%);
    }

     /* âœ… BOTTONE (via di mezzo, stile unico) */
    .buttons-row{
      display:flex;
      justify-content:center;
      width:100%;
      max-width:380px;
      margin-top:14px;
    }

    button{
      width:100%;
      padding:11px 22px;
      font-size:17.5px;
      border-radius:9px;
      border:2px solid #333;
      background:#f2f2f2;
      cursor:pointer;
    }

#startBtn{ max-width:380px; }

  </style>
</head>

<body>
  <div class="wrapper">

    <!-- SCREEN 1: VIDEO + AVVIA -->
    <div id="screen1" class="screen">
      <div class="media-slot">
        <video id="stimoloVideo" class="video-media" playsinline webkit-playsinline>
          <source id="videoSrc" type="video/mp4" />
        </video>
      </div>
      <button id="startBtn">Avvia video</button>
    </div>

    <!-- SCREEN 2: IMMAGINE + PROSSIMA FRASE -->
    <div id="screen2" class="screen">
      <div class="media-slot">
        <div class="media-wrap">
          <img id="sceltaImg" class="img-media" alt="Immagine esercizio" />
          <div id="fadeSpot" class="fade-spot" aria-hidden="true"></div>
        </div>
      </div>

      <div class="buttons-row">
        <button id="nextBtn">Prossima frase</button>
      </div>
    </div>

  </div>

  <script>
    /* =========================================================
       ðŸ”§ PARAMETRI DA CAMBIARE (come Frase attiva)
    ========================================================= */
    const ESERCIZIO = "Frase causale 3";
    const CATEGORIA = "Frasi causali";
    const STIMOLO   = "Quale quadrato cade perchÃ© un cerchio bianco lo tocca?";

    const FASE = "prova";                    // "prova preliminare" | "prova"
    const INCLUDE_IN_PUNTEGGIO = true;       // false preliminare | true prova
    const VALUTA_PRELIMINARE = true;         // se vuoi valutare anche in preliminare

    const VIDEO_SRC = "../video/Frase causale 3.mp4";
    const IMG_SRC   = "../immagini/3.png";

    // Mappa quadranti â†’ etichette
    const nomiGettoni = {
      alto_sx:  "cerchio bianco sopra",
      alto_dx:  "quadrato rosso",
      basso_sx: "cerchio bianco sotto",
      basso_dx: "quadrato nero"
    };

    const GETTONE_CORRETTO = "quadrato rosso";
    /* ========================================================= */

    // âœ… Salvataggio separato (come Frase attiva)
    const STORAGE_KEY = (FASE === "prova preliminare")
      ? "risposte_preliminare_sessione"
      : "risposte_sessione";

    const screen1  = document.getElementById("screen1");
    const screen2  = document.getElementById("screen2");
    const video    = document.getElementById("stimoloVideo");
    const videoSrc = document.getElementById("videoSrc");
    const startBtn = document.getElementById("startBtn");

    const img      = document.getElementById("sceltaImg");
    const nextBtn  = document.getElementById("nextBtn");
    const fadeSpot = document.getElementById("fadeSpot");

    let haToccato = false;
    let haRisposto = false;
    let gettoneScelto = null;

    // carica media
    videoSrc.src = VIDEO_SRC;
    video.load();

    img.src = IMG_SRC;

    /* -------------------------
       VIDEO: avvio manuale
    ------------------------- */
    startBtn.addEventListener("click", () => {
      startBtn.style.visibility = "hidden";
      video.currentTime = 0;
      video.play().catch(()=>{});
    });

    /* Quando finisce il video â†’ schermata immagine */
    video.addEventListener("ended", () => {
      setTimeout(() => {
        screen1.style.display = "none";
        screen2.style.display = "flex";
      }, 150);
    });

    /* -------------------------
       QUADRANTE
    ------------------------- */
    function calcolaQuadrante(evt) {
      const r = img.getBoundingClientRect();
      const x = evt.clientX - r.left;
      const y = evt.clientY - r.top;
      if (y < r.height / 2) return (x < r.width / 2) ? "alto_sx" : "alto_dx";
      return (x < r.width / 2) ? "basso_sx" : "basso_dx";
    }

    function fissaSpot(quadrante) {
      const r = img.getBoundingClientRect();
      const cx = quadrante.endsWith("sx") ? r.width * 0.25 : r.width * 0.75;
      const cy = quadrante.startsWith("alto") ? r.height * 0.25 : r.height * 0.75;
      const size = Math.max(150, Math.min(320, Math.min(r.width, r.height) * 0.52));
      fadeSpot.style.width  = size + "px";
      fadeSpot.style.height = size + "px";
      fadeSpot.style.left   = cx + "px";
      fadeSpot.style.top    = cy + "px";
    }

    // pointerdown = meglio su tablet rispetto a click
    img.addEventListener("pointerdown", (e) => {
      if (haToccato) return;

      const q = calcolaQuadrante(e);
      fissaSpot(q);

      haToccato = true;
      haRisposto = true;
      gettoneScelto = nomiGettoni[q] || null;
    });

    /* -------------------------
       SALVATAGGIO (identico a Frase attiva)
    ------------------------- */
    function salva(record) {
      const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
      arr.push(record);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    }

    function valutaESalva() {
      const rispostaTxt = haRisposto
        ? (gettoneScelto || "tocco_non_mappato")
        : "nessun gettone";

      const base = {
        esercizio: ESERCIZIO,
        categoria: CATEGORIA,
        stimolo: STIMOLO,

        fase: FASE,
        include_in_punteggio: INCLUDE_IN_PUNTEGGIO,

        ha_risposto: haRisposto,
        risposta_grezza: rispostaTxt,
        descrizione_risposta: haRisposto
          ? ("Ha toccato il " + rispostaTxt)
          : "Non ha toccato alcun gettone",

        timestamp: new Date().toISOString()
      };

      const devoValutare = INCLUDE_IN_PUNTEGGIO || (FASE === "prova preliminare" && VALUTA_PRELIMINARE);

      if (!devoValutare) {
        salva(base);
        return;
      }

      const corretta = haRisposto && gettoneScelto === GETTONE_CORRETTO;
      salva({ ...base, corretta: corretta, punteggio: corretta ? 1 : 0 });
    }

    /* -------------------------
       PROSSIMA FRASE
    ------------------------- */
    nextBtn.addEventListener("click", () => {
      valutaESalva();
      location.href = "index.html";
    });
  </script>
</body>
</html>






